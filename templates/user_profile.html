<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - SM Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans p-6">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">
                {% if current_user.is_master %}Master Settings{% else %}My Profile (Read Only){% endif %}
            </h1>
            <a href="{{ url_for('home') }}" class="text-blue-600 hover:underline">Back to Dashboard</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %} border border-green-300">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if current_user.is_master %}
        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-8">
            <h3 class="font-bold text-lg text-indigo-800 mb-2">Create New User</h3>
            <form method="POST" class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-indigo-600 uppercase">Username</label>
                    <input type="text" name="new_username" class="border rounded p-2 text-sm w-full" placeholder="user1" required>
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-bold text-indigo-600 uppercase">Password</label>
                    <input type="text" name="new_password" class="border rounded p-2 text-sm w-full" placeholder="pass123" required>
                </div>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700">Create User</button>
            </form>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 mb-2">Select User Profile to Edit:</label>
            <select onchange="window.location.href='?edit_user='+this.value" class="border p-2 rounded w-full md:w-1/3 bg-white shadow-sm">
                {% for u in all_users %}
                    <option value="{{ u }}" {% if target_user == u %}selected{% endif %}>
                        {{ u }} {% if u == current_user.id %} (You) {% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-2 gap-6 relative">
            <input type="hidden" name="target_user_id" value="{{ target_user }}">
            
            {% if not current_user.is_master %}
            <div class="absolute inset-0 bg-white bg-opacity-10 z-10 cursor-not-allowed"></div>
            {% endif %}

            <div class="col-span-1 md:col-span-2 bg-gray-50 p-4 rounded border">
                <h3 class="font-bold text-lg text-gray-700 mb-2">Invoice Configuration</h3>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium">Invoice Number Prefix</label>
                        <input type="text" name="invoice_prefix" value="{{ profile.get('invoice_prefix','TE') }}" class="w-full border rounded p-2 uppercase" {% if not current_user.is_master %}disabled{% endif %}>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-400">Preview</label>
                        <input type="text" disabled value="{{ profile.get('invoice_prefix','TE') }}/2025-26/0001" class="w-full border rounded p-2 bg-gray-100 text-gray-500">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="font-bold text-lg text-gray-700">Company Details</h3>
                <input type="text" name="company_name" value="{{ profile.get('company_name','') }}" class="w-full border rounded p-2" placeholder="Company Name" {% if not current_user.is_master %}disabled{% endif %}>
                <input type="text" name="address_1" value="{{ profile.get('address_1','') }}" class="w-full border rounded p-2" placeholder="Address Line 1" {% if not current_user.is_master %}disabled{% endif %}>
                <input type="text" name="address_2" value="{{ profile.get('address_2','') }}" class="w-full border rounded p-2" placeholder="Address Line 2" {% if not current_user.is_master %}disabled{% endif %}>
                <input type="text" name="phone" value="{{ profile.get('phone','') }}" class="w-full border rounded p-2" placeholder="Phone" {% if not current_user.is_master %}disabled{% endif %}>
                <input type="email" name="email" value="{{ profile.get('email','') }}" class="w-full border rounded p-2" placeholder="Email" {% if not current_user.is_master %}disabled{% endif %}>
                <input type="text" name="gstin" value="{{ profile.get('gstin','') }}" class="w-full border rounded p-2" placeholder="GSTIN" {% if not current_user.is_master %}disabled{% endif %}>
            </div>

            <div class="space-y-4">
                <h3 class="font-bold text-lg text-gray-700">Bank Details</h3>
                <input type="text" name="bank_name" value="{{ profile.get('bank_name','') }}" class="w-full border rounded p-2" placeholder="Bank Name" {% if not current_user.is_master %}disabled{% endif %}>
                <input type="text" name="account_holder" value="{{ profile.get('account_holder','') }}" class="w-full border rounded p-2" placeholder="Account Holder" {% if not current_user.is_master %}disabled{% endif %}>
                <input type="text" name="account_no" value="{{ profile.get('account_no','') }}" class="w-full border rounded p-2" placeholder="Account No" {% if not current_user.is_master %}disabled{% endif %}>
                <input type="text" name="ifsc" value="{{ profile.get('ifsc','') }}" class="w-full border rounded p-2" placeholder="IFSC Code" {% if not current_user.is_master %}disabled{% endif %}>
            </div>

            <div class="col-span-1 md:col-span-2 space-y-4 border-t pt-4">
                <h3 class="font-bold text-lg text-gray-700">Branding</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium">Logo</label>
                        <input type="file" name="logo" class="w-full border rounded p-2" {% if not current_user.is_master %}disabled{% endif %}>
                        {% if profile.get('logo_base64') %} <p class="text-xs text-green-600">✓ Logo Set by Admin</p> {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Signature</label>
                        <input type="file" name="signature" class="w-full border rounded p-2" {% if not current_user.is_master %}disabled{% endif %}>
                        {% if profile.get('signature_base64') %} <p class="text-xs text-green-600">✓ Signature Set by Admin</p> {% endif %}
                    </div>
                </div>
            </div>

            {% if current_user.is_master %}
            <div class="col-span-1 md:col-span-2 text-center mt-6">
                <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg">Save Settings</button>
            </div>
            {% endif %}
        </form>
    </div>
</body>
</html>